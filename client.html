<!--
	in the future we namy simply compile this into the binary
			but for now this file needs to be in the path of the executable
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<title>An XHTML 1.0 Strict standard template</title>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />

	<style type="text/css">

body { color: #fff ; background-color: #000 ; }
/*#mainTable { position: fixed ; margin: auto ; }*/
#contentTr , #chatTable { height: 100% ; }
table , #chatEntryInput { width: 100% ; }
#progressTable { width: 100% ; border: 1px solid white ; }

	</style>

	<script type="text/javascript">
// DEBUG
var DEBUG = true ;
var DEBUGVB = false ;
var DbgTextInput
var DbgSpan ;

var INIT_INTERVAL = 1000 ;
var POLL_INTERVAL = 1000 ;//125 ;

// sparse messages
var INIT_SIGNAL = 'init' ;
var BPM_SIGNAL = 'bpm' ;
var BPI_SIGNAL = 'bpi' ;
var METROMUTE_SIGNAL = 'metromute' ;
var CHAT_SIGNAL = 'chat' ;
// periodic messages
var PROGRESS_SIGNAL = 'progress' ;

var MAX_CHAT_LINES = 5 ;
var PROGRESS_COLOR = 'blue' ;
var BEAT_COLOR = 'green' ;

var Events = new Array() ; // [ [event , data] , ... ]

var Body ;
var ChatMessagesTable ;
var ChatEntryInput ;
var ChordsTr ;
var LoopTr ;
var StatusLTd ;
var StatusLMd ;
var StatusLRd ;

var PollInterval ;
var XmlHttp ;

var Bpm ;
var Bpi ;
var Beat ;


function initGui()
{
	Body = document.getElementsByTagName('body')[0] ;
	var mainTable = document.createElement('table') ;
	var menuTr = document.createElement('tr') ;
	var contentTr = document.createElement('tr') ;
	var metroMuteInput = document.createElement('input') ;
	var chatTable = document.createElement('table') ;
	var chatMessagesTr = document.createElement('tr') ;
	var chatMessagesTd = document.createElement('td') ;
	ChatMessagesTable = document.createElement('table') ;
	var chatEntryTr = document.createElement('tr') ;
	var chatEntryTd = document.createElement('td') ;
	ChatEntryInput = document.createElement('input') ;
	var chatSubmitTd = document.createElement('td') ;
	var chatSubmitInput = document.createElement('input') ;
DbgSpan = document.createElement('span') ;
	var progressTr = document.createElement('tr') ;
	var progressTable = document.createElement('table') ;
	ChordsTr = document.createElement('tr') ;
	LoopTr = document.createElement('tr') ;
	var statusbarTr = document.createElement('tr') ;
	var statusTable = document.createElement('table') ;
	var statusTr = document.createElement('tr') ;
	StatusLTd = document.createElement('td') ;
	StatusMTd = document.createElement('td') ;
	StatusRTd = document.createElement('td') ;

	metroMuteInput.type = 'button' ;
	metroMuteInput.value = 'MetroMute' ;
	metroMuteInput.onclick = toggleMetroMute ;

	contentTr.setAttribute('id' , 'contentTr') ;
	chatTable.setAttribute('id' , 'chatTable') ;
	ChatEntryInput.setAttribute('id' , 'chatEntryInput') ;
	ChatEntryInput.type = 'text' ;
	ChatEntryInput.autoforus = 'autofocus' ;
	ChatEntryInput.onkeydown = function(ev)
		{ var key = ev.keyCode || ev.which ; if (key == 13) sendChat() ; }	
	chatSubmitInput.type = 'button' ;
	chatSubmitInput.value = 'Chat' ;
	chatSubmitInput.onclick = sendChat ;
	progressTable.setAttribute('id' , 'progressTable') ;

	Body.appendChild(mainTable) ;
	mainTable.appendChild(menuTr) ;
menuTr.appendChild(metroMuteInput) ; menuTr.appendChild(DbgSpan) ;
	mainTable.appendChild(contentTr) ;
	contentTr.appendChild(chatTable) ;
	chatTable.appendChild(chatMessagesTr) ;
	chatMessagesTr.appendChild(chatMessagesTd) ;
	chatMessagesTd.appendChild(ChatMessagesTable) ;
	chatTable.appendChild(chatEntryTr) ;
	chatEntryTr.appendChild(chatEntryTd) ;
	chatEntryTd.appendChild(ChatEntryInput) ;
	chatEntryTr.appendChild(chatSubmitTd) ;
	chatSubmitTd.appendChild(chatSubmitInput) ;
	mainTable.appendChild(progressTr) ;
	progressTr.appendChild(progressTable) ;
	progressTable.appendChild(ChordsTr) ;
	progressTable.appendChild(LoopTr) ;
	mainTable.appendChild(statusbarTr) ;
	statusbarTr.appendChild(statusTable) ;
	statusTable.appendChild(statusTr) ;
	statusTr.appendChild(StatusLTd) ;
	statusTr.appendChild(StatusMTd) ;
	statusTr.appendChild(StatusRTd) ;

	PollInterval = window.setInterval(function() { initSend() ; } , INIT_INTERVAL) ;
}


// input events from user

function toggleMetroMute() { eventQueue(METROMUTE_SIGNAL , "") ; } ;

function sendChat()
	{ eventQueue(CHAT_SIGNAL , ChatEntryInput.value) ; ChatEntryInput.value = "" ; }

function eventQueue(event , data) { Events.push(event + "?data=" + data) ; }


// gui<->app messaging

function initSend()
{
if (DEBUG) console.log("initSend()") ;

	XmlHttp = new XMLHttpRequest() ; XmlHttp.onreadystatechange = initReceive ;
	XmlHttp.open("GET" , INIT_SIGNAL , true ) ; XmlHttp.send(null) ;
}

function initReceive()
{
if (DEBUG && XmlHttp.readyState == 4) console.log("initReceive() status=" + XmlHttp.status) ;

	if (XmlHttp.readyState != 4 || XmlHttp.status != 200) return ;

	window.clearInterval(PollInterval) ;
	PollInterval = window.setInterval(eventSend , POLL_INTERVAL) ;

if (DEBUG) console.log("initReceive() responseText=" + (DbgSpan.innerHTML = XmlHttp.responseText)) ;

	dispachEvents(eval("(" + XmlHttp.responseText + ")")) ;

handleChat("chat0") ; handleChat("chat1") ; handleChat("chat2") ; handleChat("chat3") ;
handleChat("chat4") ; handleChat("chat5") ; handleChat("chat6") ; handleChat("chat7") ;
handleChat("chat8") ; handleChat("chat9") ; handleChat("chat10") ; handleChat("chat11") ;
handleChat("chat12") ; handleChat("chat13") ; handleChat("chat14") ; handleChat("chat15") ;
handleChat("chat16") ; handleChat("chat17") ; handleChat("chat18") ; handleChat("chat19") ;
handleChat("chat20") ; handleChat("chat21") ; handleChat("chat22") ; handleChat("chat23") ;
}

function eventSend()
{
	var eventData = Events.shift() || "idle" ;

if (DEBUGVB) console.log("eventSend() event=" + eventData) ;

	XmlHttp = new XMLHttpRequest() ; XmlHttp.onreadystatechange = eventsReceive ;
	XmlHttp.open("GET" , eventData , true ) ; XmlHttp.send(null) ;
}

function eventsReceive()
{
if (DEBUGVB && XmlHttp.readyState == 4) console.log("eventReceive() status=" + XmlHttp.status) ;

	if (XmlHttp.readyState != 4 || XmlHttp.status != 200) return ;

if (DEBUGVB) console.log("eventReceive() responseText=" + XmlHttp.responseText) ;
DbgSpan.innerHTML = XmlHttp.responseText ;

	dispachEvents(eval("(" + XmlHttp.responseText + ")")) ;
}

function dispachEvents(eventsObj)
{
// TODO: method dictionary
//	for (event in eventsObj) AppEventHandlers[event] ;
if (DEBUGVB) for (ev in eventsObj) console.log("eventsObj[" + ev + "]=" + eventsObj[ev]) ;
if (eventsObj.hasOwnProperty(BPM_SIGNAL)) handleBpm(eventsObj[BPM_SIGNAL]) ;
if (eventsObj.hasOwnProperty(BPI_SIGNAL)) handleBpi(eventsObj[BPI_SIGNAL]) ;
if (eventsObj.hasOwnProperty(CHAT_SIGNAL)) handleChat(eventsObj[CHAT_SIGNAL]) ;
if (eventsObj.hasOwnProperty(PROGRESS_SIGNAL)) handleProgress(eventsObj[PROGRESS_SIGNAL]) ;
}


// output events from app

function handleBpm(bpm) { Bpm = bpm ; updateStatus() ; }

function handleBpi(bpi) { Bpi = bpi ; updateStatus() ; updateLoopTable() ; }

function handleChat(chat)
{
	var chatTr = document.createElement('tr') ; var rows = ChatMessagesTable.rows ;
	chatTr.appendChild(newTd(chat)) ; ChatMessagesTable.appendChild(chatTr) ;
	if (rows.length > MAX_CHAT_LINES) ChatMessagesTable.removeChild(rows[0]) ;
}

function handleProgress(beat)
{
	if (Beat == beat) return ;

if (DEBUGVB) console.log("nCells=" + LoopTr.cells.length); if (!LoopTr.cells.length) return ;

	if (Beat > beat) for (var i = 0 ; i < LoopTr.cells.length ; ++i)
		LoopTr.cells[i].style.backgroundColor = 'transparent' ;

	for (var i = 0 ; i < beat ; ++i) LoopTr.cells[i].style.backgroundColor = PROGRESS_COLOR ;
	LoopTr.cells[beat].style.backgroundColor = BEAT_COLOR ;

	Beat = beat ; updateStatus() ;
}

function updateStatus()
	{ StatusRTd.innerHTML =  (Beat + 1) + "/" + Bpi + " BPI @ " + Bpm + " BPM" ; }

function updateLoopTable()
{
if (DEBUG) console.log("updateLoopTable()  IN nCells=" +  LoopTr.cells.length + " Bpi=" + Bpi) ;

	var nCells = LoopTr.cells.length ;
	while (nCells > Bpi)
	{
		ChordsTr.removeChild(LoopTr.cells[nCells]) ;
		LoopTr.removeChild(LoopTr.cells[nCells--]) ;
	}
	while (nCells++ < Bpi)
		{ ChordsTr.appendChild(newTd("&nbsp;")) ; LoopTr.appendChild(newTd("&nbsp;")) ; }

if (DEBUG) console.log("updateLoopTable() OUT nCells=" +  LoopTr.cells.length + " Bpi=" + Bpi) ;
}


// instantiation

function newTd(text)
	{ var cell = document.createElement('td') ; cell.innerHTML = text ; return cell ; }

/*
function setColSpan()
{
var x=document.getElementById('myTable').rows[0].cells;
x[0].colSpan="2";
x[1].colSpan="6";
}
*/

console.log("client loaded") ;
	</script>
</head><body onload="initGui();"></body></html>
